@model Application.DTOs.OrderDto

@{
    ViewData["Title"] = "Edit Order";
    var items = ViewBag.Items as List<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>;
    var isCancelled = Model.Status == Domain.Enums.OrderStatus.CANCELLED;
}

<h1>Edit Order</h1>

<h4>Order: @Model.OrderNumber</h4>
<hr />

<div class="row">
    <div class="col-md-8">
        <form asp-action="Edit" method="post">
            <div asp-validation-summary="All" class="text-danger"></div>
            <input type="hidden" name="id" value="@ViewBag.OrderId" />

            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <strong>Order Information</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Order Number:</strong> @Model.OrderNumber</p>
                            <p><strong>Order Date:</strong> @Model.OrderDate.ToString("yyyy-MM-dd HH:mm")</p>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label"><strong>Status</strong></label>
                                <select name="Status" class="form-control" id="status-select">
                                    @foreach (var status in Enum.GetValues<Domain.Enums.OrderStatus>())
                                    {
                                        <option value="@status" selected="@(Model.Status == status)">@status</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (isCancelled)
            {
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This order has been cancelled. You cannot edit the items.
                </div>
            }

            <div class="card mb-3" id="items-card" style="@(isCancelled ? "display:none;" : "")">
                <div class="card-header bg-primary text-white">
                    <strong>Order Items</strong>
                </div>
                <div class="card-body">
                    <div id="order-items-container">
                        @foreach (var orderItem in Model.OrderItems)
                        {
                            <div class="order-item-row border rounded p-3 mb-2 bg-light">
                                <div class="row align-items-center">
                                    <div class="col-md-5">
                                        <label class="control-label">Item</label>
                                        <input type="hidden" name="OrderItemIds" value="@orderItem.Id" />
                                        <select name="ItemIds" class="form-control item-select" required>
                                            <option value="">-- Select Item --</option>
                                            @if (items != null)
                                            {
                                                @foreach (var item in items)
                                                {
                                                    var isSelected = item.Value == orderItem.ItemId.ToString();
                                                    <option value="@item.Value" data-price="@GetItemPrice(item.Text)"
                                                        selected="@isSelected">@item.Text</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="control-label">Quantity</label>
                                        <input type="number" name="Quantities" class="form-control quantity-input" min="1"
                                            value="@orderItem.Quantity" required />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="control-label">Unit Price</label>
                                        <p class="form-control-plaintext unit-price">@orderItem.Price.ToString("C")</p>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="control-label">Subtotal</label>
                                        <p class="form-control-plaintext subtotal">@orderItem.Subtotal.ToString("C")</p>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="control-label">&nbsp;</label>
                                        <button type="button"
                                            class="btn btn-danger btn-sm remove-item-btn d-block">✕</button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <button type="button" class="btn btn-success mt-2" id="add-item-btn">
                        + Add Item
                    </button>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <strong>Order Summary</strong>
                </div>
                <div class="card-body">
                    <p><strong>Total Items:</strong> <span id="total-items">@Model.OrderItems.Sum(x =>
                                                        x.Quantity)</span></p>
                    <p><strong>Total Amount:</strong> <span id="estimated-total">@Model.TotalAmount.ToString("C")</span>
                    </p>
                </div>
            </div>

            <div class="form-group mt-3">
                <input type="submit" value="Save Changes" class="btn btn-primary btn-lg" />
                <a asp-action="Index" class="btn btn-secondary btn-lg ml-2">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- Item Row Template -->
<template id="item-row-template">
    <div class="order-item-row border rounded p-3 mb-2 bg-light">
        <div class="row align-items-center">
            <div class="col-md-5">
                <label class="control-label">Item</label>
                <input type="hidden" name="OrderItemIds" value="@Guid.Empty" />
                <select name="ItemIds" class="form-control item-select" required>
                    <option value="">-- Select Item --</option>
                    @if (items != null)
                    {
                        @foreach (var item in items)
                        {
                            <option value="@item.Value" data-price="@GetItemPrice(item.Text)">@item.Text</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="control-label">Quantity</label>
                <input type="number" name="Quantities" class="form-control quantity-input" min="1" value="1" required />
            </div>
            <div class="col-md-2">
                <label class="control-label">Unit Price</label>
                <p class="form-control-plaintext unit-price">$0.00</p>
            </div>
            <div class="col-md-2">
                <label class="control-label">Subtotal</label>
                <p class="form-control-plaintext subtotal">$0.00</p>
            </div>
            <div class="col-md-1">
                <label class="control-label">&nbsp;</label>
                <button type="button" class="btn btn-danger btn-sm remove-item-btn d-block">✕</button>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const container = document.getElementById('order-items-container');
            const addBtn = document.getElementById('add-item-btn');
            const template = document.getElementById('item-row-template');
            const statusSelect = document.getElementById('status-select');
            const itemsCard = document.getElementById('items-card');

            // Handle status change
            statusSelect.addEventListener('change', function () {
                if (this.value === 'CANCELLED') {
                    itemsCard.style.display = 'none';
                } else {
                    itemsCard.style.display = 'block';
                }
            });

            // Attach events to existing rows
            container.querySelectorAll('.order-item-row').forEach(function (row) {
                attachRowEvents(row);
            });

            addBtn.addEventListener('click', function () {
                addItemRow();
            });

            function addItemRow() {
                const clone = template.content.cloneNode(true);
                container.appendChild(clone);

                const rows = container.querySelectorAll('.order-item-row');
                const newRow = rows[rows.length - 1];
                attachRowEvents(newRow);
                updateSummary();
            }

            function attachRowEvents(row) {
                row.querySelector('.remove-item-btn').addEventListener('click', function () {
                    if (container.querySelectorAll('.order-item-row').length > 1) {
                        row.remove();
                        updateSummary();
                    } else {
                        alert('Order must have at least one item.');
                    }
                });

                row.querySelector('.item-select').addEventListener('change', function () {
                    updateRowSubtotal(row);
                    updateSummary();
                });

                row.querySelector('.quantity-input').addEventListener('input', function () {
                    updateRowSubtotal(row);
                    updateSummary();
                });
            }

            function updateRowSubtotal(row) {
                const select = row.querySelector('.item-select');
                const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
                const selectedOption = select.options[select.selectedIndex];
                const priceText = selectedOption.dataset.price || '0';
                const price = parseFloat(priceText) || 0;
                const subtotal = price * quantity;
                row.querySelector('.unit-price').textContent = '$' + price.toFixed(2);
                row.querySelector('.subtotal').textContent = '$' + subtotal.toFixed(2);
            }

            function updateSummary() {
                const rows = container.querySelectorAll('.order-item-row');
                let totalItems = 0;
                let totalAmount = 0;

                rows.forEach(function (row) {
                    const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
                    const select = row.querySelector('.item-select');
                    const selectedOption = select.options[select.selectedIndex];
                    const priceText = selectedOption.dataset.price || '0';
                    const price = parseFloat(priceText) || 0;

                    if (select.value && quantity > 0) {
                        totalItems += quantity;
                        totalAmount += price * quantity;
                    }
                });

                document.getElementById('total-items').textContent = totalItems;
                document.getElementById('estimated-total').textContent = '$' + totalAmount.toFixed(2);
            }

            // Initial summary update
            updateSummary();
        });
    </script>
}

@functions {
    string GetItemPrice(string text)
    {
        try
        {
            var parts = text.Split('-');
            if (parts.Length >= 2)
            {
                var pricePart = parts[1].Trim();
                var priceMatch = System.Text.RegularExpressions.Regex.Match(pricePart, @"[\$€£]?([\d,]+\.?\d*)");
                if (priceMatch.Success)
                {
                    return priceMatch.Groups[1].Value.Replace(",", "");
                }
            }
        }
        catch { }
        return "0";
    }
}